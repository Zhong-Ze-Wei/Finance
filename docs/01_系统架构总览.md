# 🏗️ OmniTrade AI - 系统价格体系架构详解

本文档详细描述了系统如何处理多资产（加密货币、美股、A股）的价格与K线数据流。系统采用分层架构，确保数据源的灵活性和高可用性。

## 1. 核心分层架构

系统数据流分为四层，自下而上：

| 层级 | 名称 | 职责 | 关键文件 |
| :--- | :--- | :--- | :--- |
| **L1: 展示层 (UI)** | 负责实时渲染、图表展示、跳动效果 | `src/components/PriceHeader.jsx` <br> `src/components/CryptoChart.jsx` |
| **L2: 业务层 (Business)** | 数据组装、技术指标计算 (Vegas/RSI)、AI 上下文构建 | `src/utils/indicators.js` <br> `src/components/ChartAnalysisModal.jsx` |
| **L3: 服务层 (Service)** | **核心层**。负责路由分发、缓存策略、故障转移 (Failover) | `src/services/api.js` |
| **L4: 代理层 (Proxy)** | 解决跨域 (CORS) 和 地区限制 (Geo-blocking) | `vite.config.js` |

---

## 2. 数据流向图 (Mermaid)

### 2.1 实时价格监控流 (Price Header)

此流程负责 Header 区域的小卡片实时跳动价格。

```mermaid
graph TD
    UI[PriceHeader UI] -->|1. 收集可见资产| Logic[筛选 'coingecko' 源]
    Logic -->|2. 调用| WebSocket[connectBinanceWebSocket]
    
    WebSocket -->|3. 检查缓存| Cache{Hit Cache?}
    Cache -->|Yes| Return[返回缓存数据]
    Cache -->|No| Fetch[Polling API]
    
    Fetch -->|4. GET /api/coingecko| Proxy[Vite Proxy]
    Proxy -->|5. Forward| CoinGecko[CoinGecko API]
    
    CoinGecko --> Proxy --> WebSocket
    WebSocket -->|6. Set Cache (60s)| LocalStorage
    WebSocket -->|7. Callback| UI
```

### 2.2 K线数据获取流 (Chart & AI Analysis)

此流程是系统最复杂的部分，包含了多级容灾策略。

```mermaid
graph TD
    Request[CryptoChart / AI Analysis] -->|Call| API[fetchOHLCByAsset]
    API -->|判断 ohlcSource| Router{路由分发}
    
    Router -->|'yahoo'| Yahoo[Yahoo Finance API]
    Router -->|'sina'| Sina[新浪财经 (简化日线)]
    Router -->|'okx' / 'coingecko'| CryptoFlow[加密货币处理流程]
    
    subgraph Crypto Fallback Strategy
        CryptoFlow -->|Step 1: 检查白名单| Check{在 OKX 白名单?}
        Check -->|Yes| TryOKX[尝试 OKX API]
        Check -->|No| TryBinance
        
        TryOKX -->|Success| ReturnOKX[返回 OKX 数据]
        TryOKX -->|Fail| TryBinance[尝试 Binance API]
        
        TryBinance -->|Success| ReturnBinance[返回 Binance 数据]
        TryBinance -->|Fail (HTTP 451)| TryYahoo[兜底: Yahoo Finance]
        
        TryYahoo -->|Success| ReturnYahoo[返回 Yahoo 数据]
    end
    
    Yahoo --> Result[统一 OHLC 格式]
    Sina --> Result
    ReturnOKX --> Result
    ReturnBinance --> Result
    ReturnYahoo --> Result
```

---

## 3. 关键结果与设计逻辑

### 3.1 为什么要三级备选 (OKX -> Binance -> Yahoo)?
*   **结果**: 用户永远能看到 K 线，从未出现空白。
*   **逻辑**: 
    1.  **OKX**: 国内直连速度最快，作为首选。但它不支持所有币种（如 DOGE 现货）。
    2.  **Binance**: 全球流动性最好，数据最准。但受限于地区封锁 (HTTP 451)。
    3.  **Yahoo**: 虽有 15 分钟延迟，但**永不被封**且支持所有资产。作为最后的兜底，保证系统可用性。


### 3.2 为什么用 "伪 WebSocket"?
*   **结果**: 既有实时感，又不触发 API 限制。
*   **逻辑**: CoinGecko 的免费 API 有严格限制。真正的 WebSocket 维护成本高。我们采用 "60秒轮询 + 本地缓存" 策略，并在 UI 端通过 React 状态更新模拟跳动，实现了低成本的实时体验。

---

## 4. 文档导航
*   **[02_API路由与数据源策略](02_API路由与数据源策略.md)** - 深入了解代码级的 API 实现细节。
*   **[03_组件级价格逻辑](03_组件级价格逻辑.md)** - UI 组件如何消费这些数据。
